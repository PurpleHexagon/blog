{"componentChunkName":"component---src-gatsby-theme-sky-lite-templates-post-js","path":"/posts/fast-jsonapi-1","result":{"data":{"mdx":{"body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"id\": \"fast-jsonapi-1\",\n  \"title\": \"A lightning fast JSON:API serializer for Ruby Objects\",\n  \"author\": \"JonDay\",\n  \"featuredImage\": \"grayscale-photo-of-computer-laptop-near-white-notebook-and-169573.jpg\",\n  \"tags\": [\"ruby\", \"rails\", \"api\"]\n};\n\nvar makeShortcode = function makeShortcode(name) {\n  return function MDXDefaultShortcode(props) {\n    console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n    return mdx(\"div\", props);\n  };\n};\n\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"When building RESTful APIs I generally try to use build them using a HATEOAS architecture. JSON API is my preferred specification to adhere to, though previously I was often using Hal+json\\nbut found JSON API to gel with me personally more. I am also keen to try and JSON-LD which looks like it could be a game changer but that\\u2019s a story for another day and another post.\"), mdx(\"p\", null, \"In a recent RoR project I went looking for a good library to use to implement JSON API in my Rails API. After some research I found that a combination of Netflix fast_jsonapi and restful-jsonapi packages was the best route to take.\"), mdx(\"p\", null, \"Whilst the documentation on the Netflix repositories was fairly good to get me started, when I started doing more complex things I was finding I had to dig through the sourcecode and debug it myself. So I decided to document what I have found for my benefit in the future and hopefully others may also find this helpful.\"), mdx(\"p\", null, \"I\\u2019m not going to go into the general setup of these libraries as this can already be found in the readme files. The repositories I\\u2019m using are \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/Netflix/fast_jsonapi\"\n  }), \"https://github.com/Netflix/fast_jsonapi\"), \" and \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/Netflix/restful-jsonapi\"\n  }), \"https://github.com/Netflix/restful-jsonapi\"), \".\"), mdx(\"p\", null, mdx(\"em\", {\n    parentName: \"p\"\n  }, \"Example code is taken from an Agritech application I am currently writing.\")), mdx(\"p\", null, mdx(\"em\", {\n    parentName: \"p\"\n  }, mdx(\"strong\", {\n    parentName: \"em\"\n  }, \"Disclaimer: Since I worked out these techniques myself I am unsure if I am fully using the libraries correctly and to their potential. If anyone works out some better ways to use I\\u2019d be interested to hear their techniques.\"))), mdx(\"h2\", null, \"POSTing data\"), mdx(\"p\", null, \"I used the restful-jsonapi library to capture user input from POST request body.\"), mdx(\"p\", null, \"I wanted to be able to send POST requests with the following body to be able to create a farm resource, create a relationship with an existing company and create a new related field resource.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-json\"\n  }), \"{\\n    \\\"data\\\": {\\n        \\\"attributes\\\": {\\n            \\\"name\\\": \\\"My Farm\\\",\\n            \\\"description\\\": \\\"Farm 1\\\",\\n        },\\n        \\\"relationships\\\": {\\n          \\\"company\\\": {\\n            \\\"data\\\": {\\\"id\\\": \\\"1\\\"}\\n          },\\n          \\\"fields\\\": {\\n            \\\"data\\\": [\\n                {\\n                \\\"attributes\\\": {\\n                    \\\"name\\\": \\\"Top Field\\\",\\n                    \\\"description\\\": \\\"You know the big at the top.\\\",\\n                }\\n            }]\\n          }\\n        }\\n    }\\n}\\n\")), mdx(\"p\", null, \"I found the follow controller code was required to achieve this:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-ruby\"\n  }), \"class FarmsController < ApplicationController\\n  before_action :set_farm, only: [:show, :edit, :update, :destroy]\\n\\n  # POST /farms\\n  def create\\n    @farm = Farm.new(farm_params_jsonapi)\\n\\n    respond_to do |format|\\n      if @farm.save\\n        format.html { redirect_to @farm, notice: 'Farm was successfully created.' }\\n        format.json {\\n          options = {}\\n          options[:is_collection] = false\\n\\n          render json: FarmSerializer.new(@farm, options).serialized_json\\n        }\\n      else\\n        errors = fetch_errors(@farm)\\n\\n        format.html { render :new }\\n\\n        format.json {\\n          render json: RequestErrorSerializer.new(errors).serialized_json,\\n                 status: :unprocessable_entity\\n        }\\n      end\\n    end\\n  end\\n\\n  private\\n    # Use callbacks to share common setup or constraints between actions.\\n    def set_farm\\n      @farm = Farm.find(params[:id])\\n    end\\n\\n    def farm_params\\n      params[:include] ||= []\\n\\n      params.permit([include: []], [page: [:number, :size]], :id, :all)\\n    end\\n\\n    def farm_params_jsonapi\\n      restify_param(:farm).require(:farm)\\n                          .permit(\\n                            :id,\\n                            :name,\\n                            :description,\\n                            :company_id,\\n                            fields_attributes: [\\n                                :id,\\n                                :name,\\n                                :description,\\n                            ],\\n                            fields: [\\n                                :id,\\n                                :name,\\n                                :description,\\n                            ],\\n                            relationships: []\\n                          )\\n    end\\n\\n    def fetch_errors\\n      errors = []\\n        entity.errors.each do |key, value|\\n          errors << Error.new(key, value)\\n        end\\n\\n      return errors\\n    end\\nend\\n\")), mdx(\"p\", null, \"The library will transform the data so that nested related data will be flattened and the property will be appended with \\u2018_attributes\\u2019.\"), mdx(\"p\", null, \"In order to have new records created automatically I found I needed to add the following to my rails model.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-ruby\"\n  }), \"class Farm\\n  def fields_attributes=(fieldsData)\\n    self.fields = Field.create(fieldsData)\\n  end\\nend\\n\")), mdx(\"p\", null, \"Having to add the \\u2018_attributes\\u2019 property to the params hash and having to then add a method to my models was not how I was hoping this would work. But I personally couldn\\u2019t find a better way to do this so far and decided that since this worked I would crack on with actually building my API.\"), mdx(\"h3\", null, \"Serializers\"), mdx(\"p\", null, \"For transformering and serializing data from a Ruby object to JSON in the correct data shape I used fast_jsonapi.\"), mdx(\"p\", null, \"An example of a serailizer:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-ruby\"\n  }), \"class FarmSerializer\\n  include FastJsonapi::ObjectSerializer\\n  attributes :id\\n  attributes :name\\n  attributes :description\\n  has_many :fields\\nend\\n\")), mdx(\"p\", null, \"An example of this class in use can be seen above in the controller codeblock. The code is fairly simple, just need to include FastJsonapi::ObjectSerializer then define attributes and relationships much like a Rails Model.\"), mdx(\"h2\", null, \"Paging\"), mdx(\"p\", null, \"Pagination can be done the following way.\"), mdx(\"p\", null, \"Ensure that you are allowing page params from user input such as\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {}), \"def model_params\\n  params[:include] ||= []\\n\\n  params.permit([include: []], [page: [:number, :size]], :id)\\nend\\n\")), mdx(\"p\", null, \"To use these parameters you can extract the values and set sensible defaults, passing these to your query:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {}), \"if params.dig(:page, :number).nil? == false\\n    page_number = params[:page][:number]\\nelse\\n    page_number = 1\\nend\\n\\nif params.dig(:page, :size).nil? == false\\n    page_size = params[:page][:size]\\nelse\\n    page_size = 50\\nend\\n\\noffset = (page_number.to_i - 1) * page_size.to_i\\n\\nentities = Farm.all.offset(offset).limit(page_size)\\n\")), mdx(\"p\", null, \"You can then use a query string such as:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {}), \"/farms?page[number]=2&page[size]=10\\n\")), mdx(\"h2\", null, \"Included\"), mdx(\"p\", null, \"JSON API has the ability to switch between including relationships when you make a GET request and not including them.\"), mdx(\"p\", null, \"This can be controlled using a query string parameter of \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"include\"), \".\"), mdx(\"p\", null, \"Example:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {}), \"/farms?include[]=fields\\n\")), mdx(\"p\", null, \"This endpoint will now return full related field models in the included section of the response\"), mdx(\"h2\", null, \"Managing Errors\"), mdx(\"p\", null, \"To manage errors I created a an error serializer and a method to build up an error response for a single record or a collection.\"), mdx(\"p\", null, \"error.rb\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-ruby\"\n  }), \"\\nclass Error\\n  attr_accessor :detail, :title\\n\\n  @detail = []\\n  @title = []\\n\\n  def initialize(title, detail)\\n    @title = title\\n    @detail = detail\\n  end\\nend\\n\")), mdx(\"p\", null, \"request_error_serializer.rb\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-ruby\"\n  }), \"class RequestErrorSerializer\\n  include FastJsonapi::ErrorSerializer\\n\\n  attributes :title, :detail\\nend\\n\")), mdx(\"p\", null, \"error_serializer.rb\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-ruby\"\n  }), \"require 'fast_jsonapi'\\n\\nmodule FastJsonapi::ErrorSerializer\\n  extend ActiveSupport::Concern\\n\\n  included do\\n    attr_accessor :with_root_key\\n\\n    include FastJsonapi::ObjectSerializer\\n    set_id :title\\n\\n    def initialize(resource, options = {})\\n      super\\n      @with_root_key = options[:with_root_key] != false\\n    end\\n\\n    def hash_for_one_record\\n      logger.info super[:data]\\n      serialized_hash = super[:data]&[:attributes]\\n      return !with_root_key ? serialized_hash : {\\n          errors: serialized_hash\\n      }\\n    end\\n\\n    def hash_for_collection\\n      serialized_hash = super[:data]&.map{|err| err[:attributes]}\\n      return !with_root_key ? serialized_hash : {\\n          errors: serialized_hash\\n      }\\n    end\\n  end\\nend\\n\")));\n}\n;\nMDXContent.isMDXComponent = true;","frontmatter":{"id":"fast-jsonapi-1","title":"A lightning fast JSON:API serializer for Ruby Objects","tags":["ruby","rails","api"],"featuredImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBAgX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAG05oMFh//EABgQAQEBAQEAAAAAAAAAAAAAAAEAEgIR/9oACAEBAAEFAtHMo8tttt77f//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABgQAAIDAAAAAAAAAAAAAAAAAAAQETFB/9oACAEBAAY/AqJeL//EABwQAQEBAAIDAQAAAAAAAAAAAAERACGRMUFRgf/aAAgBAQABPyFIWhwsEvi4C8s1/nWD9dNfNn4b/9oADAMBAAIAAwAAABCQz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EAB0QAQADAAEFAAAAAAAAAAAAAAEAESExQVFhkbH/2gAIAQEAAT8QuOB0gYHjD1FNK7VKGjqBaOW9L9ltYPgCf//Z","aspectRatio":1.5,"src":"/static/7143a49f2107ad0eb01aaca79a9fff12/c108b/grayscale-photo-of-computer-laptop-near-white-notebook-and-169573.jpg","srcSet":"/static/7143a49f2107ad0eb01aaca79a9fff12/7dae8/grayscale-photo-of-computer-laptop-near-white-notebook-and-169573.jpg 320w,\n/static/7143a49f2107ad0eb01aaca79a9fff12/47052/grayscale-photo-of-computer-laptop-near-white-notebook-and-169573.jpg 640w,\n/static/7143a49f2107ad0eb01aaca79a9fff12/c108b/grayscale-photo-of-computer-laptop-near-white-notebook-and-169573.jpg 1280w,\n/static/7143a49f2107ad0eb01aaca79a9fff12/14dee/grayscale-photo-of-computer-laptop-near-white-notebook-and-169573.jpg 1920w,\n/static/7143a49f2107ad0eb01aaca79a9fff12/cc37d/grayscale-photo-of-computer-laptop-near-white-notebook-and-169573.jpg 2560w,\n/static/7143a49f2107ad0eb01aaca79a9fff12/39b3c/grayscale-photo-of-computer-laptop-near-white-notebook-and-169573.jpg 5472w","sizes":"(max-width: 1280px) 100vw, 1280px"}}}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"postId":"fast-jsonapi-1","postDate":"2020-04-12","previousPath":"/posts/covid19-1","nextPath":"/posts/sliding-puzzle-1"}}}