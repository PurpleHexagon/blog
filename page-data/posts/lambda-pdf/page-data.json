{"componentChunkName":"component---plugins-gatsby-theme-sky-lite-src-templates-post-js","path":"/posts/lambda-pdf/","result":{"data":{"mdx":{"body":"var _excluded = [\"components\"];\nfunction _extends() { _extends = Object.assign ? Object.assign.bind() : function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n/* @jsxRuntime classic */\n/* @jsx mdx */\n\nvar _frontmatter = {\n  \"id\": \"lambda-pdf\",\n  \"title\": \"AWS Lambda PDF Service\",\n  \"author\": \"JonDay\",\n  \"featuredImage\": \"coffee-writing-computer-blogging-34600.jpg\",\n  \"tags\": [\"aws\", \"javascript\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n    props = _objectWithoutProperties(_ref, _excluded);\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"I recently had to create a PDF service which needed to run on AWS Lambda using Express. I had to do a fair amount of digging to determine how to get this fully working.\"), mdx(\"p\", null, \"I decided to repeat the steps I took in my own time and document them, which hopefully will be useful for someone in the future.\"), mdx(\"h3\", null, \"Key points:\"), mdx(\"p\", null, \"package.json\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-json\"\n  }, \"{\\n  \\\"name\\\": \\\"pdf\\\",\\n  \\\"version\\\": \\\"1.0.0\\\",\\n  \\\"private\\\": true,\\n  \\\"dependencies\\\": {\\n    \\\"aws-serverless-express\\\": \\\"^3.3.8\\\",\\n    \\\"chrome-aws-lambda\\\": \\\"^2.1.1\\\",\\n    \\\"express\\\": \\\"~4.16.1\\\",\\n    \\\"puppeteer-core\\\": \\\"^2.1.1\\\",\\n  },\\n  \\\"devDependencies\\\": {\\n    \\\"puppeteer\\\": \\\"^2.1.1\\\",\\n  }\\n}\\n\\n\")), mdx(\"p\", null, \"template.yml\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-yml\"\n  }, \"AWSTemplateFormatVersion: '2010-09-09'\\nTransform: AWS::Serverless-2016-10-31\\nDescription: >\\n    aws-sam-express\\n    SAM Template\\n\\nGlobals:\\n    Function:\\n        Timeout: 15\\n    Api:\\n        BinaryMediaTypes:\\n            - \\\"*~1*\\\"\\nResources:\\n    PdfApiFunction:\\n        Type: AWS::Serverless::Function\\n        Properties:\\n            FunctionName: pdf\\n            CodeUri: ./\\n            Handler: lambda.execute\\n            Runtime: nodejs12.x\\n            MemorySize: 1024\\n            Events:\\n                PdfApiRoot:\\n                    Type: Api\\n                    Properties:\\n                        Path: /\\n                        Method: ANY\\n                PdfApi:\\n                    Type: Api\\n                    Properties:\\n                        Path: /{proxy+}\\n                        Method: ANY\\n\\nOutputs:\\n\\n    PdfApi:\\n        Description: \\\"API Gateway endpoint URL\\\"\\n        Value: !Sub \\\"https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/api\\\"\\n\\n    PdfApiFunction:\\n        Description: \\\"PDF Api Lambda Function ARN\\\"\\n        Value: !GetAtt PdfApiFunction.Arn\\n\\n    PdfApiFunctionIamRole:\\n        Description: \\\"Implicit IAM Role created for PDF Api function\\\"\\n        Value: !GetAtt PdfApiFunction.Arn\\n\")), mdx(\"p\", null, \"The controller code\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"const chromium = require('chrome-aws-lambda');\\n\\n\\n/**\\n * GET /pdf\\n *\\n * Returns a PDF\\n *\\n * @param req\\n * @param res\\n * @param next\\n * @returns {Promise<*>}\\n */\\nreturn async (req, res, next) => {\\n    const { remoteContent, html } = req.body;\\n\\n    try {\\n\\n        const browser = await chromium.puppeteer.launch({\\n            args: chromium.args,\\n            defaultViewport: chromium.defaultViewport,\\n            executablePath: await chromium.executablePath,\\n            headless: chromium.headless,\\n            ignoreHTTPSErrors: true,\\n        });\\n\\n        const page = await browser.newPage();\\n        if (remoteContent === true) {\\n            await page.goto(\\n                `data:text/html;base64, ${Buffer.from(html).toString('base64')}`,\\n                { waitUntil: 'networkidle0' },\\n            );\\n        } else {\\n            await page.setContent(html);\\n        }\\n\\n        const pdf = await page.pdf({});\\n\\n        await browser.close();\\n\\n        res.setHeader('Content-Type', 'application/pdf');\\n\\n        return res.send(pdf);\\n    }\\n    catch (error) {\\n        return next(error);\\n    }\\n};\\n\")), mdx(\"p\", null, \"The following Express Serverless config was required for execute.js\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-javascript\"\n  }, \"const awsServerlessExpress = require('aws-serverless-express');\\nconst app = require('./app');\\n\\nconst binaryMimeTypes = [\\n    'application/pdf'\\n];\\n\\nconst server = awsServerlessExpress.createServer(app, null, binaryMimeTypes);\\n\\nexports.handler = (event, context) => {\\n    return awsServerlessExpress.proxy(server, event, context);\\n};\\n\")), mdx(\"p\", null, \"Once this config had been added the content from the Api Gateway was base64 encoded\"), mdx(\"p\", null, \"In order to ensure binary data is returned you must set application/pdf content type in the binaryMediaTypes list for the Api Gateway.\"), mdx(\"p\", null, \"The following link was very useful - \", mdx(\"a\", {\n    href: \"https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-payload-encodings-workflow.html\",\n    target: \"_blank\"\n  }, \"Api Gateway encodings doc\")));\n}\n;\nMDXContent.isMDXComponent = true;","frontmatter":{"id":"lambda-pdf","title":"AWS Lambda PDF Service","tags":["aws","javascript"],"featuredImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEBf/EABUBAQEAAAAAAAAAAAAAAAAAAAID/9oADAMBAAIQAxAAAAGTDY2hsNoC/8QAGhAAAwADAQAAAAAAAAAAAAAAAQIDAAQSBf/aAAgBAQABBQLcYUx16yVAkqTCUnPui+dID//EABcRAAMBAAAAAAAAAAAAAAAAAAABEQL/2gAIAQMBAT8BWIU//8QAFxEAAwEAAAAAAAAAAAAAAAAAAQMQEf/aAAgBAgEBPwEs2f/EAB8QAAIBAgcAAAAAAAAAAAAAAAABAgMRISJBUVJhof/aAAgBAQAGPwKlUT0MF6Ri6Tb6YrcbkY7mZybP/8QAGxABAAICAwAAAAAAAAAAAAAAAQARITFRcdH/2gAIAQEAAT8hTIVK0ncsqCyVFGUPYNkBGkyDStpcrvIrqf/aAAwDAQACAAMAAAAQg+//xAAWEQEBAQAAAAAAAAAAAAAAAAAAIVH/2gAIAQMBAT8Q3If/xAAWEQEBAQAAAAAAAAAAAAAAAAAAIVH/2gAIAQIBAT8Qzq//xAAdEAEBAAICAwEAAAAAAAAAAAABEQAxIVFBgZGh/9oACAEBAAE/ECGIdRYLUm3KLhsA34T9yesz4W+e2SmGgUXje8E0wtbwOqd4F2akF9TP/9k=","aspectRatio":1.5023474178403755,"src":"/static/8c3f5e8d1d5c17870dc3875ce9583437/356ef/coffee-writing-computer-blogging-34600.jpg","srcSet":"/static/8c3f5e8d1d5c17870dc3875ce9583437/107df/coffee-writing-computer-blogging-34600.jpg 320w,\n/static/8c3f5e8d1d5c17870dc3875ce9583437/38a09/coffee-writing-computer-blogging-34600.jpg 640w,\n/static/8c3f5e8d1d5c17870dc3875ce9583437/356ef/coffee-writing-computer-blogging-34600.jpg 1280w,\n/static/8c3f5e8d1d5c17870dc3875ce9583437/4fb49/coffee-writing-computer-blogging-34600.jpg 1920w,\n/static/8c3f5e8d1d5c17870dc3875ce9583437/afdd3/coffee-writing-computer-blogging-34600.jpg 2560w,\n/static/8c3f5e8d1d5c17870dc3875ce9583437/8496f/coffee-writing-computer-blogging-34600.jpg 5472w","sizes":"(max-width: 1280px) 100vw, 1280px"}}}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"postId":"lambda-pdf","postDate":"2020-06-17","previousPath":"/posts/cosine-haversine","nextPath":"/posts/have-i-been-pwned"}}}