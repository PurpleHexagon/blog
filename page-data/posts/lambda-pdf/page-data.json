{"componentChunkName":"component---src-gatsby-theme-sky-lite-templates-post-js","path":"/posts/lambda-pdf","result":{"data":{"mdx":{"body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"id\": \"lambda-pdf\",\n  \"title\": \"AWS Lambda PDF Service\",\n  \"author\": \"JonDay\",\n  \"featuredImage\": \"coffee-writing-computer-blogging-34600.jpg\",\n  \"tags\": [\"aws\", \"javascript\"]\n};\n\nvar makeShortcode = function makeShortcode(name) {\n  return function MDXDefaultShortcode(props) {\n    console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n    return mdx(\"div\", props);\n  };\n};\n\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"I recently had to create a PDF service which needed to run on AWS Lambda using Express. I had to do a fair amount of digging to determine how to get this fully working.\"), mdx(\"p\", null, \"I decided to repeat the steps I took in my own time and document them, which hopefully will be useful for someone in the future.\"), mdx(\"h3\", null, \"Key points:\"), mdx(\"p\", null, \"package.json\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-json\"\n  }), \"{\\n  \\\"name\\\": \\\"pdf\\\",\\n  \\\"version\\\": \\\"1.0.0\\\",\\n  \\\"private\\\": true,\\n  \\\"dependencies\\\": {\\n    \\\"aws-serverless-express\\\": \\\"^3.3.8\\\",\\n    \\\"chrome-aws-lambda\\\": \\\"^2.1.1\\\",\\n    \\\"express\\\": \\\"~4.16.1\\\",\\n    \\\"puppeteer-core\\\": \\\"^2.1.1\\\",\\n  },\\n  \\\"devDependencies\\\": {\\n    \\\"puppeteer\\\": \\\"^2.1.1\\\",\\n  }\\n}\\n\\n\")), mdx(\"p\", null, \"template.yml\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-yml\"\n  }), \"AWSTemplateFormatVersion: '2010-09-09'\\nTransform: AWS::Serverless-2016-10-31\\nDescription: >\\n    aws-sam-express\\n    SAM Template\\n\\nGlobals:\\n    Function:\\n        Timeout: 15\\n\\nResources:\\n    PdfApiFunction:\\n        Type: AWS::Serverless::Function\\n        Properties:\\n            FunctionName: pdf\\n            CodeUri: ./\\n            Handler: lambda.execute\\n            Runtime: nodejs12.x\\n            MemorySize: 1024\\n            Events:\\n                PdfApiRoot:\\n                    Type: Api\\n                    Properties:\\n                        Path: /\\n                        Method: ANY\\n                PdfApi:\\n                    Type: Api\\n                    Properties:\\n                        Path: /{proxy+}\\n                        Method: ANY\\n\\nOutputs:\\n\\n    PdfApi:\\n        Description: \\\"API Gateway endpoint URL\\\"\\n        Value: !Sub \\\"https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/api\\\"\\n\\n    PdfApiFunction:\\n        Description: \\\"PDF Api Lambda Function ARN\\\"\\n        Value: !GetAtt PdfApiFunction.Arn\\n\\n    PdfApiFunctionIamRole:\\n        Description: \\\"Implicit IAM Role created for PDF Api function\\\"\\n        Value: !GetAtt PdfApiFunction.Arn\\n\")), mdx(\"p\", null, \"The controller code\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-javascript\"\n  }), \"const chromium = require('chrome-aws-lambda');\\n\\n\\n/**\\n * GET /pdf\\n *\\n * Returns a PDF\\n *\\n * @param req\\n * @param res\\n * @param next\\n * @returns {Promise<*>}\\n */\\nreturn async (req, res, next) => {\\n    const { remoteContent, html } = req.body;\\n\\n    try {\\n\\n        const browser = await chromium.puppeteer.launch({\\n            args: chromium.args,\\n            defaultViewport: chromium.defaultViewport,\\n            executablePath: await chromium.executablePath,\\n            headless: chromium.headless,\\n            ignoreHTTPSErrors: true,\\n        });\\n\\n        const page = await browser.newPage();\\n        if (remoteContent === true) {\\n            await page.goto(\\n                `data:text/html;base64, ${Buffer.from(html).toString('base64')}`,\\n                { waitUntil: 'networkidle0' },\\n            );\\n        } else {\\n            await page.setContent(html);\\n        }\\n\\n        const pdf = await page.pdf({});\\n\\n        await browser.close();\\n\\n        res.setHeader('Content-Type', 'application/pdf');\\n\\n        return res.send(pdf);\\n    }\\n    catch (error) {\\n        return next(error);\\n    }\\n};\\n\")), mdx(\"p\", null, \"The following Express Serverless config was required for execute.js\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-javascript\"\n  }), \"const awsServerlessExpress = require('aws-serverless-express');\\nconst app = require('./app');\\n\\nconst binaryMimeTypes = [\\n    'application/pdf'\\n];\\n\\nconst server = awsServerlessExpress.createServer(app, null, binaryMimeTypes);\\n\\nexports.handler = (event, context) => {\\n    return awsServerlessExpress.proxy(server, event, context);\\n};\\n\")), mdx(\"p\", null, \"Once this config had been added the content from the Api Gateway was base64 encoded\"), mdx(\"p\", null, \"In order to ensure binary data is returned you must set application/pdf content type in the binaryMediaTypes list for the Api Gateway.\"), mdx(\"p\", null, \"The following link was very useful - \", mdx(\"a\", {\n    href: \"https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-payload-encodings-workflow.html\",\n    target: \"_blank\"\n  }, \"Api Gateway encodings doc\")));\n}\n;\nMDXContent.isMDXComponent = true;","frontmatter":{"id":"lambda-pdf","title":"AWS Lambda PDF Service","tags":["aws","javascript"],"featuredImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIDBP/EABUBAQEAAAAAAAAAAAAAAAAAAAEC/9oADAMBAAIQAxAAAAGWBnosbQf/xAAaEAEAAwADAAAAAAAAAAAAAAACAAERAwQS/9oACAEBAAEFAua/UutgWFHETqrrjP/EABURAQEAAAAAAAAAAAAAAAAAABAS/9oACAEDAQE/AZP/xAAWEQADAAAAAAAAAAAAAAAAAAABAhD/2gAIAQIBAT8BLT//xAAbEAACAQUAAAAAAAAAAAAAAAAAAQIQERIhgf/aAAgBAQAGPwKMqJYHBI3c/8QAGxABAAICAwAAAAAAAAAAAAAAAQARIUExYaH/2gAIAQEAAT8hKk3i3MuWHsBxKbGAQcIZ2RuCyJn/2gAMAwEAAgADAAAAEGPP/8QAFhEBAQEAAAAAAAAAAAAAAAAAABEB/9oACAEDAQE/EMhX/8QAFREBAQAAAAAAAAAAAAAAAAAAEBH/2gAIAQIBAT8Qqf/EABsQAQEAAgMBAAAAAAAAAAAAAAERACExQbGh/9oACAEBAAE/EGzEkAasd1ykNedX5gck2JPcO0IAOMIli5RZhg7ciHyZ/9k=","aspectRatio":1.5,"src":"/static/8c3f5e8d1d5c17870dc3875ce9583437/c108b/coffee-writing-computer-blogging-34600.jpg","srcSet":"/static/8c3f5e8d1d5c17870dc3875ce9583437/7dae8/coffee-writing-computer-blogging-34600.jpg 320w,\n/static/8c3f5e8d1d5c17870dc3875ce9583437/47052/coffee-writing-computer-blogging-34600.jpg 640w,\n/static/8c3f5e8d1d5c17870dc3875ce9583437/c108b/coffee-writing-computer-blogging-34600.jpg 1280w,\n/static/8c3f5e8d1d5c17870dc3875ce9583437/14dee/coffee-writing-computer-blogging-34600.jpg 1920w,\n/static/8c3f5e8d1d5c17870dc3875ce9583437/cc37d/coffee-writing-computer-blogging-34600.jpg 2560w,\n/static/8c3f5e8d1d5c17870dc3875ce9583437/39b3c/coffee-writing-computer-blogging-34600.jpg 5472w","sizes":"(max-width: 1280px) 100vw, 1280px"}}}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"postId":"lambda-pdf","postDate":"2020-06-17","previousPath":"/posts/cosine-haversine","nextPath":null}}}